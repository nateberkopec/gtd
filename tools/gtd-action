#!/usr/bin/env fish
#
# gtd-action - Todoist CLI wrapper for GTD actions/tasks
#
# Commands: list/add/complete/delete/modify/projects/labels/sync/inbox/waiting

function todoist_rest --argument-names method path payload
    set token (string match -r --groups-only '"token"\s*:\s*"([^"]+)"' (cat "$HOME/.config/todoist/config.json"))
    set url "https://api.todoist.com/rest/v2/$path"
    if test -n "$payload"
        curl --silent --show-error --fail -X "$method" -H "Authorization: Bearer $token" -H "Content-Type: application/json" -d "$payload" "$url"
    else
        curl --silent --show-error --fail -X "$method" -H "Authorization: Bearer $token" "$url"
    end
end

function todoist_name_payload --argument-names name
    set name (string replace -a '\\' '\\\\' -- (string replace -a '"' '\\"' -- $name))
    printf '{"name":"%s"}' $name
end

function task_url --argument-names id
    echo "https://todoist.com/showTask?id=$id"
end

function project_url --argument-names id
    echo "https://todoist.com/showProject?id=$id"
end

# Parse command (first positional argument)
set cmd ""
set rest
for arg in $argv
    if test -z "$cmd"; and not string match -q -- '-*' $arg
        set cmd $arg
    else
        set -a rest $arg
    end
end

# Parse flags from rest
function parse_flags
    set -g _flag_filter ""
    set -g _flag_text ""
    set -g _flag_id ""
    set -g _flag_name ""
    set -g _flag_parent_id ""
    set -g _flag_priority ""
    set -g _flag_date ""
    set -g _flag_project ""
    set -g _flag_labels ""
    set -g _passthrough

    set i 1
    while test $i -le (count $argv)
        switch $argv[$i]
            case --filter -f
                set i (math $i + 1)
                test $i -le (count $argv); and set _flag_filter $argv[$i]
            case --text -t
                set i (math $i + 1)
                test $i -le (count $argv); and set _flag_text $argv[$i]
            case --id -i
                set i (math $i + 1)
                test $i -le (count $argv); and set _flag_id $argv[$i]
            case --name -n
                set i (math $i + 1)
                test $i -le (count $argv); and set _flag_name $argv[$i]
            case --parent-id
                set i (math $i + 1)
                test $i -le (count $argv); and set _flag_parent_id $argv[$i]
            case --priority -p
                set i (math $i + 1)
                test $i -le (count $argv); and set _flag_priority $argv[$i]
            case --date -d
                set i (math $i + 1)
                test $i -le (count $argv); and set _flag_date $argv[$i]
            case --project -P
                set i (math $i + 1)
                test $i -le (count $argv); and set _flag_project $argv[$i]
            case --labels -l
                set i (math $i + 1)
                test $i -le (count $argv); and set _flag_labels $argv[$i]
            case '*'
                set -a _passthrough $argv[$i]
        end
        set i (math $i + 1)
    end
end

parse_flags $rest

switch "$cmd"
    case list l
        set args
        if test -n "$_flag_filter"
            set -a args --filter "$_flag_filter"
        end
        todoist list $args $_passthrough
    case add a
        if test -z "$_flag_text"
            echo "Error: --text required for add command" >&2
            exit 1
        end
        # Build JSON payload for REST API (todoist CLI add is buggy with flags)
        set text_escaped (string replace -a '\\' '\\\\' -- (string replace -a '"' '\\"' -- $_flag_text))
        set payload "{\"content\":\"$text_escaped\""
        if test -n "$_flag_priority"
            set payload "$payload,\"priority\":$_flag_priority"
        end
        if test -n "$_flag_date"
            set date_escaped (string replace -a '\\' '\\\\' -- (string replace -a '"' '\\"' -- $_flag_date))
            set payload "$payload,\"due_string\":\"$date_escaped\""
        end
        if test -n "$_flag_project"
            # Look up project ID by name
            set proj_escaped (string replace -a '\\' '\\\\' -- (string replace -a '"' '\\"' -- $_flag_project))
            set proj_id (todoist_rest GET "projects" | jq -r ".[] | select(.name == \"$proj_escaped\") | .id")
            if test -n "$proj_id"
                set payload "$payload,\"project_id\":\"$proj_id\""
            end
        end
        if test -n "$_flag_labels"
            # Convert comma-separated labels to JSON array
            set labels_json (string split "," $_flag_labels | string trim | xargs -I{} printf '"%s",' {} | string trim --right --chars=,)
            set payload "$payload,\"labels\":[$labels_json]"
        end
        set payload "$payload}"
        set response (todoist_rest POST "tasks" "$payload")
        todoist sync
        set task_id (echo $response | jq -r '.id')
        if test -n "$task_id"
            echo $task_id $_flag_text
            task_url $task_id
        end
    case complete c close
        if test -z "$_flag_id"
            echo "Error: --id required for complete command" >&2
            exit 1
        end
        todoist close $_flag_id $_passthrough
        task_url $_flag_id
    case delete d
        if test -z "$_flag_id"
            echo "Error: --id required for delete command" >&2
            exit 1
        end
        todoist delete $_flag_id $_passthrough
        task_url $_flag_id
    case modify m
        if test -z "$_flag_id"
            echo "Error: --id required for modify command" >&2
            exit 1
        end
        # Build JSON payload for REST API (todoist CLI modify is buggy)
        set payload "{"
        set has_field false
        if test -n "$_flag_text"
            set text_escaped (string replace -a '\\' '\\\\' -- (string replace -a '"' '\\"' -- $_flag_text))
            set payload "$payload\"content\":\"$text_escaped\""
            set has_field true
        end
        if test -n "$_flag_priority"
            if $has_field
                set payload "$payload,"
            end
            set payload "$payload\"priority\":$_flag_priority"
            set has_field true
        end
        if test -n "$_flag_date"
            if $has_field
                set payload "$payload,"
            end
            set date_escaped (string replace -a '\\' '\\\\' -- (string replace -a '"' '\\"' -- $_flag_date))
            set payload "$payload\"due_string\":\"$date_escaped\""
            set has_field true
        end
        if test -n "$_flag_labels"
            if $has_field
                set payload "$payload,"
            end
            # Convert comma-separated labels to JSON array
            set labels_json (string split "," $_flag_labels | string trim | xargs -I{} printf '"%s",' {} | string trim --right --chars=,)
            set payload "$payload\"labels\":[$labels_json]"
            set has_field true
        end
        set payload "$payload}"
        todoist_rest POST "tasks/$_flag_id" "$payload"
        todoist sync
        task_url $_flag_id
    case projects
        # Display projects hierarchically with indentation
        set token (string match -r --groups-only '"token"\s*:\s*"([^"]+)"' (cat "$HOME/.config/todoist/config.json"))
        set tmpfile (mktemp)
        curl --silent --show-error --fail -H "Authorization: Bearer $token" "https://api.todoist.com/rest/v2/projects" > $tmpfile
        
        function _print_project_tree --argument-names parent_id depth tmpfile
            set projects (cat $tmpfile | jq -r ".[] | select((.parent_id // \"null\") == \"$parent_id\") | \"\\(.id) \\(.name)\"")
            for proj in $projects
                set id (string split " " $proj)[1]
                set name (string sub -s (math (string length $id) + 2) -- $proj)
                set indent (string repeat -n $depth "  ")
                echo "$indent$id #$name"
                _print_project_tree $id (math $depth + 1) $tmpfile
            end
        end
        _print_project_tree null 0 $tmpfile
        rm -f $tmpfile
    case project-add project-create
        if test -z "$_flag_name"
            echo "Error: --name required for project-add command" >&2
            exit 1
        end
        set payload (todoist_name_payload "$_flag_name")
        if test -n "$_flag_parent_id"
            set payload (string replace -r '\\}$' ",\"parent_id\":$_flag_parent_id}" -- $payload)
        end
        set response (todoist_rest POST "projects" "$payload")
        todoist sync
        set proj_id (echo $response | jq -r '.id')
        if test -n "$proj_id"
            project_url $proj_id
        end
    case project-update project-rename
        if test -z "$_flag_id"
            echo "Error: --id required for project-update command" >&2
            exit 1
        end
        if test -z "$_flag_name"
            echo "Error: --name required for project-update command" >&2
            exit 1
        end
        set payload (todoist_name_payload "$_flag_name")
        todoist_rest POST "projects/$_flag_id" "$payload"
        todoist sync
        project_url $_flag_id
    case project-delete project-remove
        if test -z "$_flag_id"
            echo "Error: --id required for project-delete command" >&2
            exit 1
        end
        set deleted_id $_flag_id
        todoist_rest DELETE "projects/$_flag_id"
        todoist sync
        echo "Deleted project: $deleted_id"
    case labels contexts
        todoist labels
    case label-add label-create
        if test -z "$_flag_name"
            echo "Error: --name required for label-add command" >&2
            exit 1
        end
        set name (string trim --left --chars "@" -- $_flag_name)
        set payload (todoist_name_payload "$name")
        set response (todoist_rest POST "labels" "$payload")
        todoist sync
        set label_id (echo $response | jq -r '.id')
        echo "Created label: $label_id @$name"
    case label-update label-rename
        if test -z "$_flag_id"
            echo "Error: --id required for label-update command" >&2
            exit 1
        end
        if test -z "$_flag_name"
            echo "Error: --name required for label-update command" >&2
            exit 1
        end
        set name (string trim --left --chars "@" -- $_flag_name)
        set payload (todoist_name_payload "$name")
        todoist_rest POST "labels/$_flag_id" "$payload"
        todoist sync
        echo "Updated label: $_flag_id @$name"
    case label-delete label-remove
        if test -z "$_flag_id"
            echo "Error: --id required for label-delete command" >&2
            exit 1
        end
        set deleted_id $_flag_id
        todoist_rest DELETE "labels/$_flag_id"
        todoist sync
        echo "Deleted label: $deleted_id"
    case sync s
        todoist sync
    case inbox
        todoist list --filter "##Inbox"
    case waiting
        todoist list --filter "p4"
    case help -h --help ''
        echo "gtd-action - Todoist CLI wrapper for GTD actions/tasks

Commands:
  list                    List tasks
    --filter, -f FILTER     Todoist filter syntax

  add                     Add a new task
    --text, -t TEXT         Task text (required)
    --priority, -p NUM      Priority (1-4)
    --date, -d DATE         Due date
    --project, -P NAME      Project name
    --labels, -l LABELS     Label names (comma-separated)

  complete                Mark task complete
    --id, -i ID             Task ID (required)

  delete                  Delete a task
    --id, -i ID             Task ID (required)

  modify                  Modify a task
    --id, -i ID             Task ID (required)
    --text, -t TEXT         New task text
    --priority, -p NUM      New priority
    --date, -d DATE         New due date

  projects                List all projects

  project-add             Create a project
    --name, -n NAME         Project name (required)
    --parent-id ID          Parent project ID

  project-update          Update a project name
    --id, -i ID             Project ID (required)
    --name, -n NAME         New name (required)

  project-delete          Delete a project
    --id, -i ID             Project ID (required)

  labels                  List all labels (contexts)

  label-add               Create a label
    --name, -n NAME         Label name (required)

  label-update            Update a label name
    --id, -i ID             Label ID (required)
    --name, -n NAME         New name (required)

  label-delete            Delete a label
    --id, -i ID             Label ID (required)

  sync                    Sync with Todoist server
  inbox                   List inbox items only
  waiting                 List waiting-for items (P4)

Priority conventions:
  P4 = Waiting/blocked
  P3 = Workable (default)
  P1/P2 = Unused"
        exit 0
    case '*'
        echo "Unknown command: $cmd" >&2
        echo "Run 'gtd-action help' for usage" >&2
        exit 1
end
