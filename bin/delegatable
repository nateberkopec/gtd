#!/bin/bash

set -e

BATCH_SIZE=10
VERBOSE=false
ONLY_DELEGATABLE=true
MODEL=""

usage() {
    echo "Usage: delegatable [options]"
    echo ""
    echo "Analyze tasks to determine if they can be delegated to an EA or AI."
    echo ""
    echo "Options:"
    echo "  -h, --help              Display this help message"
    echo "  -v, --verbose           Run with verbose output"
    echo "  -b, --batch SIZE        Process tasks in batches of SIZE (default: 10)"
    echo "  -a, --all               Show all tasks (including non-delegatable)"
    echo "  -m, --model MODEL       Specify LLM model to use (default: llm default)"
    echo ""
    echo "Example:"
    echo "  echo 'Schedule meeting with Bob' | delegatable"
    echo "  cat tasks.txt | delegatable"
    exit 0
}

while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            usage
            ;;
        -v|--verbose)
            VERBOSE=true
            shift
            ;;
        -b|--batch)
            BATCH_SIZE="$2"
            shift 2
            ;;
        -a|--all)
            ONLY_DELEGATABLE=false
            shift
            ;;
        -m|--model)
            MODEL="$2"
            shift 2
            ;;
        *)
            echo "Unknown option: $1" >&2
            usage
            ;;
    esac
done

# Check for stdin
if [ -t 0 ]; then
    echo "Error: Please pipe tasks to this command" >&2
    echo "Example: echo 'Schedule meeting with Bob' | delegatable" >&2
    echo "For multiple tasks: cat tasks.txt | delegatable" >&2
    exit 1
fi

# Read all tasks from stdin into an array (portable version)
tasks=()
while IFS= read -r line; do
    [ -n "$line" ] && tasks+=("$line")
done

if [ ${#tasks[@]} -eq 0 ]; then
    echo "Error: No tasks received" >&2
    exit 1
fi

$VERBOSE && echo "Processing ${#tasks[@]} task(s) in batches of $BATCH_SIZE" >&2

SYSTEM_PROMPT='You are an expert in task management and delegation.
Your role is to analyze tasks and determine if they could be effectively delegated to:
1. An Executive Assistant (EA)
2. Artificial Intelligence (AI)

Guidelines for delegation:

EA-Suitable Tasks:
- Administrative work (scheduling, travel arrangements, filing)
- Research that does not require domain expertise
- Email management and correspondence
- Data entry and organization
- Basic financial tasks (expense reports, invoicing)
- Meeting coordination
- Document preparation and formatting

AI-Suitable Tasks:
- Data analysis and processing
- Content generation or editing
- Translation work
- Basic research and summarization
- Image or media processing
- Code review or documentation
- Pattern recognition tasks

NOT Delegatable Tasks:
- Strategic decisions
- Personal relationships and networking
- Creative direction
- Core business strategy
- Personal commitments
- Tasks requiring a human'\''s unique expertise or perspective

For each task, respond with either:
- "DELEGATE TO EA: <reason>" if suitable for an EA
- "AI TASK: <reason>" if it could be handled by AI
- "NOT DELEGATABLE: <reason>" if it requires personal attention

Provide a brief explanation of why it fits the category you chose, and what the next action would be to get the EA or AI to complete the task. If the resulting next action would take less than 5 minutes, suggest doing it immediately.

Return your answers with the same numbering as the input, ensuring each response is on a new line.'

# Build model argument if specified
MODEL_ARG=""
if [ -n "$MODEL" ]; then
    MODEL_ARG="-m $MODEL"
fi

# Process tasks in batches
process_batch() {
    local formatted=""
    local i=1
    local task

    for task in "$@"; do
        formatted+="$i. $task"$'\n'
        i=$((i + 1))
    done

    $VERBOSE && echo "Processing batch of $# tasks..." >&2

    # Call llm with the system prompt and formatted tasks
    echo "$formatted" | llm $MODEL_ARG -s "$SYSTEM_PROMPT" --no-stream
}

# Process in batches and collect results
all_results=""
total=${#tasks[@]}
i=0
while [ $i -lt $total ]; do
    # Build batch array
    batch=()
    j=0
    while [ $j -lt $BATCH_SIZE ] && [ $((i + j)) -lt $total ]; do
        batch+=("${tasks[$((i + j))]}")
        j=$((j + 1))
    done

    result=$(process_batch "${batch[@]}")
    all_results+="$result"$'\n'
    i=$((i + BATCH_SIZE))
done

# Parse and display results
task_index=0
current_result=""

output_result() {
    # Skip non-delegatable if only_delegatable is true
    if $ONLY_DELEGATABLE && echo "$current_result" | grep -q "^NOT DELEGATABLE"; then
        return
    fi

    if [ ${#tasks[@]} -gt 1 ]; then
        echo "Task $task_index:"
        $VERBOSE && echo "Original: ${tasks[$((task_index-1))]}"
        echo "Analysis: $current_result"
        echo ""
    else
        echo "Analysis: $current_result"
    fi
}

while IFS= read -r line; do
    # Check if line starts with a number followed by . or )
    if echo "$line" | grep -qE '^[[:space:]]*[0-9]+[.\)][[:space:]]+'; then
        # Output previous result if we have one
        if [ -n "$current_result" ] && [ $task_index -gt 0 ]; then
            output_result
        fi
        task_index=$((task_index + 1))
        # Extract the content after the number
        current_result=$(echo "$line" | sed -E 's/^[[:space:]]*[0-9]+[.\)][[:space:]]+//')
    elif [ -n "$line" ]; then
        # Continue current result
        current_result="$current_result $line"
    fi
done <<< "$all_results"

# Output the last result
if [ -n "$current_result" ] && [ $task_index -gt 0 ]; then
    output_result
fi
